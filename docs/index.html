<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#06110c" />
  <title>Tap-n-Score™ — Download SEC</title>

  <style>
    :root{
      --bg0:#050b08;
      --bg1:#06110c;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.68);

      --red:#d14a4a;
      --white:#e9eef3;
      --blue:#2f66ff;

      --mint:#51f0a1;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 30% 20%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 700px at 70% 30%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color:var(--txt);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }

    .page{
      max-width:980px;
      margin:0 auto;
      padding:24px 18px 40px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:24px;
      padding:20px;
      background:
        radial-gradient(900px 600px at 30% 20%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(900px 600px at 70% 30%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
    }

    .header{
      text-align:center;
      padding:10px 10px 6px;
    }

    .title{
      margin:0;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: clamp(26px, 4vw, 46px);
    }
    .tRed{color:var(--red)}
    .tWhite{color:var(--white)}
    .tBlue{color:var(--blue)}

    .sub{
      margin-top:10px;
      color:var(--mut);
      font-weight:800;
      letter-spacing:.20em;
      text-transform:uppercase;
      font-size:12px;
    }

    .panel{
      margin-top:14px;
      border:1px solid var(--line2);
      border-radius:20px;
      background: rgba(0,0,0,.20);
      padding:14px;
    }

    .panelTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    .label{
      font-weight:900;
      letter-spacing:.18em;
      opacity:.80;
      font-size:12px;
    }

    .meta{
      color:var(--mut);
      font-weight:700;
      font-size:12px;
      text-align:right;
    }

    .previewWrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      min-height:360px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    #previewImg{
      display:none;
      width:100%;
      height:auto;
    }

    .previewPlaceholder{
      padding:18px;
      text-align:center;
      color:rgba(255,255,255,.55);
      font-weight:800;
      max-width:420px;
    }

    .actions{
      margin-top:14px;
      border:1px solid var(--line2);
      border-radius:20px;
      background: rgba(0,0,0,.18);
      padding:14px;
    }

    .btnPrimary{
      width:100%;
      height:56px;
      border-radius:18px;
      border:1px solid rgba(81,240,161,.35);
      background: rgba(0,0,0,.22);
      color:var(--white);
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      box-shadow: 0 0 0 2px rgba(81,240,161,.08) inset;
    }

    .btnPrimary:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      border-color: rgba(255,255,255,.12);
    }

    .row2{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .btn{
      display:flex;
      align-items:center;
      justify-content:center;
      height:52px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--white);
      text-decoration:none;
      font-weight:900;
      font-size:16px;
    }

    .hint{
      margin-top:10px;
      color:rgba(255,255,255,.60);
      font-weight:650;
      font-size:12px;
      line-height:1.35;
    }

    details.diag{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:10px 12px;
      background: rgba(0,0,0,.18);
    }

    details.diag summary{
      cursor:pointer;
      font-weight:900;
      color:var(--mut);
    }

    details.diag pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      color:rgba(255,255,255,.78);
      margin:10px 0 0;
    }

    .footer{
      text-align:center;
      margin-top:18px;
      color:rgba(255,255,255,.25);
      font-weight:900;
      letter-spacing:.35em;
    }

    @media (max-width: 820px){
      .row2{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <main class="page">
    <section class="card" aria-label="SEC Download">
      <header class="header">
        <h1 class="title">
          <span class="tRed">SHOOTER</span>
          <span class="tWhite"> EXPERIENCE </span>
          <span class="tBlue">CARD</span>
        </h1>
        <div class="sub">Download</div>
      </header>

      <section class="panel" aria-label="Preview">
        <div class="panelTop">
          <div class="label">PREVIEW</div>
          <div class="meta" id="metaLine">No SEC image loaded.</div>
        </div>

        <div class="previewWrap">
          <img id="previewImg" alt="Shooter Experience Card preview" />
          <div class="previewPlaceholder" id="previewPlaceholder">
            Your Shooter Experience Card will appear here.
          </div>
        </div>
      </section>

      <section class="actions" aria-label="Actions">
        <button class="btnPrimary" id="downloadBtn" type="button" disabled>
          Download SEC PNG
        </button>

        <div class="row2">
          <a class="btn" href="./index.html">Score another</a>
          <a class="btn" href="./index.html">Back to target</a>
        </div>

        <div class="hint">
          Tip: If download doesn’t start on iPad, press-and-hold the image and “Save to Photos.”
        </div>
      </section>

      <details class="diag">
        <summary>Diagnostics</summary>
        <pre id="diagOut">(none)</pre>
      </details>

      <footer class="footer">SCZN3</footer>
    </section>
  </main>

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      const previewImg = $("previewImg");
      const previewPlaceholder = $("previewPlaceholder");
      const metaLine = $("metaLine");
      const downloadBtn = $("downloadBtn");
      const diagOut = $("diagOut");

      function getSecImage() {
        const qs = new URLSearchParams(location.search);
        const imgParam = qs.get("img");
        if (imgParam && imgParam.trim()) return { src: imgParam.trim(), source: "querystring" };

        const ss = sessionStorage.getItem("sec_png_dataurl");
        if (ss && ss.trim()) return { src: ss.trim(), source: "sessionStorage" };

        return null;
      }

      function setPreview(src, source) {
        previewImg.src = src;
        previewImg.style.display = "block";
        previewPlaceholder.style.display = "none";

        const kind = src.startsWith("data:") ? "data URL" : "URL";
        metaLine.textContent = `Loaded (${kind}) • source: ${source}`;

        downloadBtn.disabled = false;
      }

      function triggerDownload(href, filename) {
        const a = document.createElement("a");
        a.href = href;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      async function downloadFromUrl(url) {
        if (url.startsWith("data:image")) {
          triggerDownload(url, `SEC_${Date.now()}.png`);
          return;
        }

        const res = await fetch(url, { mode: "cors" });
        const blob = await res.blob();
        const objUrl = URL.createObjectURL(blob);
        triggerDownload(objUrl, `SEC_${Date.now()}.png`);
        setTimeout(() => URL.revokeObjectURL(objUrl), 2000);
      }

      downloadBtn.addEventListener("click", async () => {
        try {
          const info = getSecImage();
          if (!info) return;
          diagOut.textContent = JSON.stringify({ action: "download", info }, null, 2);
          await downloadFromUrl(info.src);
        } catch (e) {
          diagOut.textContent = String(e);
          alert("Download failed. Open Diagnostics.");
        }
      });

      const info = getSecImage();
      if (!info) {
        diagOut.textContent = JSON.stringify({
          ok: false,
          message: "No SEC image provided.",
          expected: [
            "download.html?img=<SEC image url or data url>",
            "sessionStorage.sec_png_dataurl = 'data:image/png;base64,...'"
          ]
        }, null, 2);
        return;
      }

      setPreview(info.src, info.source);
      diagOut.textContent = JSON.stringify({ ok: true, loadedFrom: info.source }, null, 2);
    })();
  </script>
</body>
</html>
